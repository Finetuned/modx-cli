#!/usr/bin/env php
<?php

if (PHP_SAPI !== 'cli') {
    echo 'Warning: MODX CLI should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;
}

require __DIR__.'/../src/bootstrap.php';

use MODX\CLI\Application;

error_reporting(-1);

if (function_exists('ini_set')) {
    @ini_set('display_errors', 1);

    $memoryInBytes = function ($value) {
        $unit = strtolower(substr($value, -1, 1));
        $value = (int) $value;
        switch($unit) {
            case 'g':
                $value *= 1024;
                // no break (cumulative multiplier)
            case 'm':
                $value *= 1024;
                // no break (cumulative multiplier)
            case 'k':
                $value *= 1024;
        }

        return $value;
    };

    $memoryLimit = trim(ini_get('memory_limit'));
    // Increase memory_limit if it is lower than 512M
    if ($memoryLimit != -1 && $memoryInBytes($memoryLimit) < 512 * 1024 * 1024) {
        @ini_set('memory_limit', '512M');
    }
    unset($memoryInBytes, $memoryLimit);
}

$argv = $_SERVER['argv'] ?? [];
if (!empty($argv)) {
    $commandIndex = array_search('self-update', $argv, true);
    if ($commandIndex === false) {
        $commandIndex = array_search('update', $argv, true);
    }
    if ($commandIndex !== false) {
        $wantsJson = in_array('--json', $argv, true);
        foreach ($argv as $index => $value) {
            if ($value === '--version' || strpos($value, '--version=') === 0) {
                if ($wantsJson) {
                    echo json_encode([
                        'success' => false,
                        'message' => '--version is a global option and is not valid for self-update. Use --target-version or --to.',
                    ], JSON_PRETTY_PRINT) . PHP_EOL;
                } else {
                    fwrite(STDERR, "Error: --version is a global option and is not valid for self-update. Use --target-version or --to.\n");
                }
                exit(1);
            }
            if ($value === '--latest-version' || strpos($value, '--latest-version=') === 0) {
                if ($wantsJson) {
                    echo json_encode([
                        'success' => false,
                        'message' => '--latest-version is not a valid option for self-update. Use --target-version or --to.',
                    ], JSON_PRETTY_PRINT) . PHP_EOL;
                } else {
                    fwrite(STDERR, "Error: --latest-version is not a valid option for self-update. Use --target-version or --to.\n");
                }
                exit(1);
            }
            if ($value === '-v') {
                $next = $argv[$index + 1] ?? '';
                if ($next !== '' && $next[0] !== '-') {
                    if ($wantsJson) {
                        echo json_encode([
                            'success' => false,
                            'message' => '-v does not accept a value for self-update. Use --target-version or --to.',
                        ], JSON_PRETTY_PRINT) . PHP_EOL;
                    } else {
                        fwrite(STDERR, "Error: -v does not accept a value for self-update. Use --target-version or --to.\n");
                    }
                    exit(1);
                }
            }
            if (strpos($value, '-v=') === 0) {
                if ($wantsJson) {
                    echo json_encode([
                        'success' => false,
                        'message' => '-v does not accept a value for self-update. Use --target-version or --to.',
                    ], JSON_PRETTY_PRINT) . PHP_EOL;
                } else {
                    fwrite(STDERR, "Error: -v does not accept a value for self-update. Use --target-version or --to.\n");
                }
                exit(1);
            }
        }
    }
}

// run the command application
$application = new Application();
$application->run();
